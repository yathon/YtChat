const svgTitle = `<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 -3 24 24" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`;
const svgYt = `<svg width="30" height="30" viewBox="0 10 35 35" xmlns="http://www.w3.org/2000/svg"><g><text transform="matrix(1.44177 0 0 1.15166 -491.926 -309.611)" stroke="#000" font-weight="bold" xml:space="preserve" text-anchor="start" font-family="'Crimson Pro'" font-size="16" y="296.41798" x="342.69604" stroke-width="0" fill="#000000">Yt</text></g></svg>`;
const svgAi = `<svg width="20" height="20" viewBox="-10 -10 50 50" fill="none" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5" class="h-6 w-6"><path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707ZM22.4978 37.8849C20.7443 37.8874 19.0459 37.2733 17.6994 36.1501C17.7601 36.117 17.8666 36.0586 17.936 36.0161L25.9004 31.4156C26.1003 31.3019 26.2663 31.137 26.3813 30.9378C26.4964 30.7386 26.5563 30.5124 26.5549 30.2825V19.0542L29.9213 20.998C29.9389 21.0068 29.9541 21.0198 29.9656 21.0359C29.977 21.052 29.9842 21.0707 29.9867 21.0902V30.3889C29.9842 32.375 29.1946 34.2791 27.7909 35.6841C26.3872 37.0892 24.4838 37.8806 22.4978 37.8849ZM6.39227 31.0064C5.51397 29.4888 5.19742 27.7107 5.49804 25.9832C5.55718 26.0187 5.66048 26.0818 5.73461 26.1244L13.699 30.7248C13.8975 30.8408 14.1233 30.902 14.3532 30.902C14.583 30.902 14.8088 30.8408 15.0073 30.7248L24.731 25.1103V28.9979C24.7321 29.0177 24.7283 29.0376 24.7199 29.0556C24.7115 29.0736 24.6988 29.0893 24.6829 29.1012L16.6317 33.7497C14.9096 34.7416 12.8643 35.0097 10.9447 34.4954C9.02506 33.9811 7.38785 32.7263 6.39227 31.0064ZM4.29707 13.6194C5.17156 12.0998 6.55279 10.9364 8.19885 10.3327C8.19885 10.4013 8.19491 10.5228 8.19491 10.6071V19.808C8.19351 20.0378 8.25334 20.2638 8.36823 20.4629C8.48312 20.6619 8.64893 20.8267 8.84863 20.9404L18.5723 26.5542L15.206 28.4979C15.1894 28.5089 15.1703 28.5155 15.1505 28.5173C15.1307 28.5191 15.1107 28.516 15.0924 28.5082L7.04046 23.8557C5.32135 22.8601 4.06716 21.2235 3.55289 19.3046C3.03862 17.3858 3.30624 15.3413 4.29707 13.6194ZM31.955 20.0556L22.2312 14.4411L25.5976 12.4981C25.6142 12.4872 25.6333 12.4805 25.6531 12.4787C25.6729 12.4769 25.6928 12.4801 25.7111 12.4879L33.7631 17.1364C34.9967 17.849 36.0017 18.8982 36.6606 20.1613C37.3194 21.4244 37.6047 22.849 37.4832 24.2684C37.3617 25.6878 36.8382 27.0432 35.9743 28.1759C35.1103 29.3086 33.9415 30.1717 32.6047 30.6641C32.6047 30.5947 32.6047 30.4733 32.6047 30.3889V21.188C32.6066 20.9586 32.5474 20.7328 32.4332 20.5338C32.319 20.3348 32.154 20.1698 31.955 20.0556ZM35.3055 15.0128C35.2464 14.9765 35.1431 14.9142 35.069 14.8717L27.1045 10.2712C26.906 10.1554 26.6803 10.0943 26.4504 10.0943C26.2206 10.0943 25.9948 10.1554 25.7963 10.2712L16.0726 15.8858V11.9982C16.0715 11.9783 16.0753 11.9585 16.0837 11.9405C16.0921 11.9225 16.1048 11.9068 16.1207 11.8949L24.1719 7.25025C25.4053 6.53903 26.8158 6.19376 28.2383 6.25482C29.6608 6.31589 31.0364 6.78077 32.2044 7.59508C33.3723 8.40939 34.2842 9.53945 34.8334 10.8531C35.3826 12.1667 35.5464 13.6095 35.3055 15.0128ZM14.2424 21.9419L10.8752 19.9981C10.8576 19.9893 10.8423 19.9763 10.8309 19.9602C10.8195 19.9441 10.8122 19.9254 10.8098 19.9058V10.6071C10.8107 9.18295 11.2173 7.78848 11.9819 6.58696C12.7466 5.38544 13.8377 4.42659 15.1275 3.82264C16.4173 3.21869 17.8524 2.99464 19.2649 3.1767C20.6775 3.35876 22.0089 3.93941 23.1034 4.85067C23.0427 4.88379 22.937 4.94215 22.8668 4.98473L14.9024 9.58517C14.7025 9.69878 14.5366 9.86356 14.4215 10.0626C14.3065 10.2616 14.2466 10.4877 14.2479 10.7175L14.2424 21.9419ZM16.071 17.9991L20.4018 15.4978L24.7325 17.9975V22.9985L20.4018 25.4983L16.071 22.9985V17.9991Z" fill="currentColor"></path></svg>`;
const openaiEndpoint = 'https://api.openai.com/v1/chat/completions';

let roleId = 0
const roleMap = {
	'none': {
		'disabled': false,
		'selected': false,
		'text': '--无--',
		'prefix': ''
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': true,
		'text': '代码解释',
		'prefix': '以markdown样式返回输入的代码，并对代码进行全面的注释，包括代码结构和实现细节，以便理解和维护；并对代码进行全面的测试，以便发现并解决其中的漏洞和错误，不用返回测试代码；并为代码提供更好的性能和可读性的优化方案：'
	},
	[`role${roleId++}`]: {
		'disabled': true,
		'selected': false,
		'text': '英语词典',
		'prefix': ''
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '中英互译',
		'prefix': '你是英语和中文专家，我下边所有的输入都是需要翻译的句子，如果输入中文，请翻译为英文，如果输入英文，则翻译为中文，只需要返回翻译结果即可，需要翻译的句子如下：'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '充当英语翻译和改进者',
		'prefix': '我想让你充当英语翻译员、拼写纠正员和改进员。我会用任何语言与你交谈，你会检测语言，翻译它并用我的文本的更正和改进版本用英语回答。我希望你用更优美优雅的高级英语单词和句子替换我简化的 A0 级单词和句子。保持相同的意思，但使它们更文艺。我要你只回复更正、改进，不要写任何解释'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '做英语口语老师和提高者',
		'prefix': '我想让你充当英语口语老师和提高者。我会用英语和你说话，你会用英语回复我来练习我的英语口语。我希望您的回复保持整洁，将回复限制在 100 个字以内。我希望你严格纠正我的语法错误、拼写错误和事实错误。我希望你在回复中问我一个问题。现在让我们开始练习吧，你可以先问我一个问题。记住，我要你严格纠正我的语法错误、拼写错误和事实错误。'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '软件工程师面试官',
		'prefix': '我想让你担任面试官。我将成为候选人，您将向我询问该软件工程师职位的面试问题。我希望你只作为面试官回答。不要一次写出所有的守恒。我希望你只对我进行采访。问我问题，等待我的回答。不要写解释。像面试官一样一个一个问我，等我回答。'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '作为广告商',
		'prefix': '我想让你充当广告商。您将创建一个活动来推广您选择的产品或服务。您将选择目标受众，制定关键信息和口号，选择宣传媒体渠道，并决定实现目标所需的任何其他活动。'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '充当讲故事的人',
		'prefix': '我想让你扮演讲故事的角色。您将想出引人入胜、富有想象力和吸引观众的有趣故事。它可以是童话故事、教育故事或任何其他类型的故事，有可能吸引人们的注意力和想象力。根据目标受众，您可以为讲故事环节选择特定的主题或主题，例如，如果是儿童，则可以谈论动物；如果是成年人，那么基于历史的故事可能会更好地吸引他们等等。'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '扮演脱口秀喜剧演员',
		'prefix': '我想让你扮演一个脱口秀喜剧演员。我将为您提供一些与时事相关的话题，您将运用您的智慧、创造力和观察能力，根据这些话题创建一个例程。您还应该确保将个人轶事或经历融入日常活动中，以使其对观众更具相关性和吸引力。'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '担任辩手',
		'prefix': '我要你扮演辩手。我会为你提供一些与时事相关的话题，你的任务是研究辩论的双方，为每一方提出有效的论据，驳斥对立的观点，并根据证据得出有说服力的结论。你的目标是帮助人们从讨论中解脱出来，增加对手头主题的知识和洞察力。'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '担任辩论教练',
		'prefix': '我想让你担任辩论教练。我将为您提供一组辩手和他们即将举行的辩论的动议。你的目标是通过组织练习回合来让团队为成功做好准备，练习回合的重点是有说服力的演讲、有效的时间策略、反驳对立的论点，以及从提供的证据中得出深入的结论。'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '充当诗人',
		'prefix': '我要你扮演诗人。你将创作出能唤起情感并具有触动人心的力量的诗歌。写任何主题或主题，但要确保您的文字以优美而有意义的方式传达您试图表达的感觉。您还可以想出一些短小的诗句，这些诗句仍然足够强大，可以在读者的脑海中留下印记。请根据我给出的描述创作诗歌：'
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '英语词典',
		'prefix': ''
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '英语词典',
		'prefix': ''
	},
	[`role${roleId++}`]: {
		'disabled': false,
		'selected': false,
		'text': '英语词典',
		'prefix': ''
	},
	'custom': {
		'disabled': false,
		'selected': false,
		'text': '自定义',
		'prefix': ''
	}
};

const AVATAR_USER = 0;
const AVATAR_AI = 1;
const AVATAR_SYSTEM = -1;

let titleIndex = 1;
let currTitleIndex = 1;
let currMsgId = 0;
let newChatFlag = true;
let chatMap = {};

var settings = {
	'dark': true,
	'fabricate': true,
	'hljs': true,
	'apikey': '',
	'role': '',
	'prefix': ''
};
function id(x, p) {
	const p_ = p || document;
	return p_.getElementById(x);
}
function idSlct(s, p) {
	const p_ = p || document;
	return p_.querySelector(s);
}
function tags(t, p) {
	const p_ = p || document;
	return p_.getElementsByTagName(t);
}

var os = (function() {
	var UserAgent = navigator.userAgent.toLowerCase();
	return {
		isIpad          : /ipad/.test(UserAgent),
		isIphone        : /iphone os/.test(UserAgent),
		isAndroid       : /android/.test(UserAgent),
		isWindowsCe     : /windows ce/.test(UserAgent),
		isWindowsMobile : /windows mobile/.test(UserAgent),
		isWin2K         : /windows nt 5.0/.test(UserAgent),
		isXP            : /windows nt 5.1/.test(UserAgent),
		isVista         : /windows nt 6.0/.test(UserAgent),
		isWin7          : /windows nt 6.1/.test(UserAgent),
		isWin8          : /windows nt 6.2/.test(UserAgent),
		isWin81         : /windows nt 6.3/.test(UserAgent),
		isWin10         : /windows nt 10.0/.test(UserAgent),
		isMac           : /mac os/.test(UserAgent)
	};
}());
var bw = (function() {
    var UserAgent = navigator.userAgent.toLowerCase();
    return {
        isUc      : /ucweb/.test(UserAgent), // UC浏览器
        isChrome  : /chrome/.test(UserAgent.substr(-33,6)), // Chrome浏览器
        isFirefox : /firefox/.test(UserAgent), // 火狐浏览器
        isOpera   : /opera/.test(UserAgent),  // Opera浏览器
        isSafire  : /safari/.test(UserAgent) && !/chrome/.test(UserAgent), // safire浏览器
        is360     : /360se/.test(UserAgent), // 360浏览器
        isBaidu   : /bidubrowser/.test(UserAgent), // 百度浏览器
        isSougou  : /metasr/.test(UserAgent), // 搜狗浏览器
        isIE6     : /msie 6.0/.test(UserAgent), // IE6
        isIE7     : /msie 7.0/.test(UserAgent), // IE7
        isIE8     : /msie 8.0/.test(UserAgent), // IE8
        isIE9     : /msie 9.0/.test(UserAgent), // IE9
        isIE10    : /msie 10.0/.test(UserAgent), // IE10
        isIE11    : /msie 11.0/.test(UserAgent), // IE11
        isLB      : /lbbrowser/.test(UserAgent), // 猎豹浏览器
　　　　 isWX      : /micromessenger/.test(UserAgent), // 微信内置浏览器
        isQQ      : /qqbrowser/.test(UserAgent) // QQ浏览器
    };
}());
var browser={
	versions:function(){
		var u = navigator.userAgent, app = navigator.appVersion;
		return {
			trident: u.indexOf('Trident') > -1, //IE内核
			presto: u.indexOf('Presto') > -1, //opera内核
			webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
			gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1,//火狐内核
			mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
			ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
			android: u.indexOf('Android') > -1 || u.indexOf('Adr') > -1, //android终端
			iPhone: u.indexOf('iPhone') > -1 , //是否为iPhone或者QQHD浏览器
			iPad: u.indexOf('iPad') > -1, //是否iPad
			webApp: u.indexOf('Safari') == -1, //是否web应该程序，没有头部与底部
			weixin: u.indexOf('MicroMessenger') > -1, //是否微信
			qq: u.match(/\sQQ/i) == " qq" //是否QQ
		};
	}(),
	language:(navigator.browserLanguage || navigator.language).toLowerCase()
};

var isWin = (navigator.platform == "Win32") || (navigator.platform == "Windows");
var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");
var isMobile = (os.isIpad || os.isIphone || os.isAndroid || os.isWindowsCe || os.isWindowsMobile || browser.versions.mobile || browser.versions.android || browser.versions.ios);

const titleList = idSlct('.sidebar .title-list');
const chatList = idSlct('.chat-list');
const chatInput = idSlct('.chat-input textarea');
const menu = id('menuSvg');
const menuTitle = id('menuTitle');
const settingsDiv = id('settingsDiv');
const settingsRole = id('settingsRole');
const regenerate = idSlct('.regenerate');

function elShaking(el) {
	const maxAngle = 3 // 震动偏移角度
	const interval = 10 // 震动快慢，数字越小越快，太小DOM反应不过来，看不出动画
	const quarterCycle = 6 // 一次完整来回震动的四分之一周期
	let curAngle = 0
	let direction = 1
	const timer = setInterval(function() {
		if (direction > 0) {
			curAngle++;
			if (curAngle === maxAngle) {
				direction = -1;
			}
		} else {
			curAngle--;
			if (curAngle === -maxAngle) {
				direction = 1;
			}
		}
		el.style.transform = 'rotate(' + curAngle + 'deg)';
	}, interval);
	setTimeout(function() {
		clearInterval(timer)
	}, maxAngle * interval * quarterCycle);
}

function createNewChat() {
	if (!hideSidebar()) return;
	chatList.innerHTML = '';
	menuTitle.innerHTML = '';
	chatInput.value = '';
	if (chatMap && chatMap.hasOwnProperty(`chatTitle${titleIndex}`) && chatMap[`chatTitle${titleIndex}`].msgs.length > 0) {
		titleIndex += 1;
	}
	newChatFlag = true;
	currMsgId = 0;
	currTitleIndex = titleIndex;
	regenerate.style.display = 'none';
}

function clickPre() {
	if (settingsDiv.style.display !== '' && settingsDiv.style.display !== 'none') {
		id('saveSettings').focus();
		elShaking(settingsDiv);
		return false;
	}
	return true;
}

function hideSidebar() {
	if (!clickPre()) {
		return false;
	}
	if (browser.versions.mobile || browser.versions.android || browser.versions.ios || document.documentElement.clientWidth <= 768) {
		idSlct('.sidebar').style.display = 'none';
		menu.style.display = 'inline-flex';
	}
	return true;
}

async function sendMsg() {
	if (!hideSidebar()) return;
	const message = chatInput.value.trim();
	if (!message) return;

	if (settings.apikey.length < 1) {
		alert("APIKEY 为空！请在【设置】中输入并保存");
		id('settingsDiv').style.display = 'flex';
		return;
	}
	let avatar = AVATAR_USER;
	appendMsgToList(currMsgId, message, avatar);
	chatList.scrollTo(0, chatList.scrollHeight);
	if (newChatFlag) {
		appendTitleToList(message);
	} else {
		chatMap[`chatTitle${currTitleIndex}`]['msgs'].push({
			"id": currMsgId,
			"content": message,
			"avatar": avatar
		});
	}
	currMsgId += 1;
	chatInput.value = '';
	chatInput.style.height = '40px';
	await getText(message, streamShowContent);
}

window.addEventListener("resize", function() {
	if (document.documentElement.clientWidth > 768) {
		idSlct('.sidebar').style.display = 'inline-flex';
		menu.style.display = 'none';
	} else {
		idSlct('.sidebar').style.display = 'none';
		menu.style.display = 'inline-flex';
	}
});
id('menuSvg').addEventListener('click', function() {
	if (!hideSidebar()) return;
	idSlct('.sidebar').style.display = 'inline-flex';
	this.style.display = 'none';
});
idSlct('.chat-container').addEventListener('click', hideSidebar);
id('newChat').addEventListener('click', createNewChat);
id('newChatSvg').addEventListener('click', createNewChat);
id('clearChat').addEventListener('click', function() {
	if (!hideSidebar()) return;
	if (confirm("确定要清空所有会话吗？\n清空后无法恢复，请谨慎操作！")) {
		chatList.innerHTML = '';
		titleList.innerHTML = '';
		menuTitle.innerHTML = '';
		chatInput.value = '';
		titleIndex = 1;
		currTitleIndex = 1;
		currMsgId = 0;
		newChatFlag = true;
		chatMap = {};
		regenerate.style.display = 'none';
	}
});
id('userInfo').addEventListener('click', function() {
	if (!hideSidebar()) return;
	alert('userInfo');
});
id('settings').addEventListener('click', function() {
	if (!hideSidebar()) return;
	settingsDiv.style.display = 'flex';
	id('darkMode').checked = settings.dark;
	id('fabricate').checked = settings.fabricate;
	id('hljsMode').checked = settings.hljs;
	id('apikey').value = settings.apikey;
	settingsRole.value = settings.role;
	if (settings.role === 'custom') {
		idSlct('.settings-prefix').style.display = 'block';
	} else {
		idSlct('.settings-prefix').style.display = 'none';
	}
	id('prefix').value = settings.prefix;
});
settingsRole.addEventListener('change', function() {
	if (this.value === 'custom') {
		idSlct('.settings-prefix').style.display = 'block';
	} else {
		idSlct('.settings-prefix').style.display = 'none';
	}
});
id('saveSettings').addEventListener('click', function() {
	if (id('apikey').value === '') {
		alert('APIKEY 不能为空！');
		return;
	}
	settings.dark = id('darkMode').checked;
	settings.fabricate = id('fabricate').checked;
	settings.hljs = id('hljsMode').checked;
	settings.apikey = id('apikey').value;
	settings.role = settingsRole.value;
	settings.prefix = id('prefix').value;
	settingsDiv.style.display = 'none';
});
id('cancelSettings').addEventListener('click', function() {
	settingsDiv.style.display = 'none';
});
id('getHelp').addEventListener('click', function() {
	if (!hideSidebar()) return;
	alert('请发送邮件到管理员邮箱：\nyf.lz2013@gmail.com');
});
id('logOut').addEventListener('click', function() {
	if (!hideSidebar()) return;
	alert('logOut');
});
idSlct('.regenerate button').addEventListener('click', async () => {
	if (!hideSidebar()) return;
	if (settings.apikey.length < 1) {
		alert("APIKEY 为空！请在【设置】中输入并保存");
		id('settingsDiv').style.display = 'flex';
		return;
	}
	regenerate.style.display = 'none';
	await getText('', streamShowContent, true);
});
chatInput.addEventListener('input', function() {
	if (!hideSidebar()) return;
	if (this.value.length > 0) {
		this.style.height = this.scrollHeight + 'px';
	} else {
		this.style.height = '40px';
	}
});
chatInput.addEventListener('propertychange', function() {
	if (!hideSidebar()) return;
	if (this.value.length > 0) {
		this.style.height = 'auto';
	} else {
		this.style.height = '40px';
	}
});
chatInput.addEventListener('keydown', async function(event){
    if (event.keyCode === 13 && ((isWin && event.ctrlKey) || (isMac && event.metaKey))) {
        await sendMsg();
    }
});
idSlct('.chat-input button').addEventListener('click', async () => {
	await sendMsg();
});

function appendTitleToList(msg) {
	if (!msg) return;
	const title = msg;

	const titleDivList = tags('div', titleList);
	for (let div of titleDivList) {
		div.classList.remove('a-actived');
	}
	const titleDiv = document.createElement('div');
	titleDiv.classList.add('sidebar-a');
	titleDiv.classList.add('a-actived');
	titleDiv.id = `chatTitle${titleIndex}`;
	const titleSpan = document.createElement('span');
	titleSpan.innerHTML = `${svgTitle} ${title}`;
	titleDiv.appendChild(titleSpan);
	titleDiv.addEventListener('click', function() {
		loadChat(titleDiv.id);
	});
	titleList.appendChild(titleDiv);
	chatMap[`chatTitle${currTitleIndex}`] = {
		"title": title,
		"msgs": []
	}
	if (settings.role && settings.role !== 'none') {
		let content = roleMap[settings.role]?.prefix;
		if (settings.role === 'custom') {
			content = settings.prefix;
		}
		if (content?.length > 1) {
			chatMap[`chatTitle${currTitleIndex}`]['msgs'].push({
				'id': -1,
				'content': content,
				'avatar': AVATAR_SYSTEM
			});
		}
	}
	chatMap[`chatTitle${currTitleIndex}`]['msgs'].push({
		"id": currMsgId,
		"content": msg,
		"avatar": AVATAR_USER
	});
	currMsgId += 1;
	newChatFlag = false;
	menuTitle.innerHTML = title;
}

function appendMsgToList(msgId, msg, avatar) {
	const chatItem = document.createElement('div');
	chatItem.id = `chatItem${msgId}`;
	chatItem.classList.add('chat-item');

	const avatarDiv = document.createElement('div');
	avatarDiv.classList.add('avatar');
	if (avatar == AVATAR_USER) {
		avatarDiv.innerHTML = svgYt;
		chatItem.classList.add('user');
	} else {
		avatarDiv.innerHTML = svgAi;
		chatItem.classList.add('bot');
	}

	const contentDiv = document.createElement('div');
	contentDiv.classList.add('content');
	myHighlightElement(contentDiv, msg);

	chatItem.appendChild(avatarDiv);
	chatItem.appendChild(contentDiv);
	chatList.appendChild(chatItem);
}

function loadChat(idx) {
	if (idx == `chatTitle${currTitleIndex}`) {
		return;
	}
	chatList.innerHTML = '';
	chatInput.value = '';
	currMsgId = 0;
	if (chatMap && chatMap.hasOwnProperty(idx) && chatMap[idx].msgs.length > 0) {
		newChatFlag = false;
		currTitleIndex = parseInt(idx.slice(9));
		const msgs = chatMap[idx].msgs;
		for (let i = 0; i < msgs.length; i++) {
			if (msgs[i].id == -1) continue;
			if (i === 0) {
				menuTitle.innerHTML = msgs[i].content;
			}
			appendMsgToList(i, msgs[i].content, msgs[i].avatar);
		}
		currMsgId = msgs.length;
	}
	const titleDivList = tags('div', titleList);
	for (let div of titleDivList) {
		div.classList.remove('a-actived');
	}
	const thisTitle = id(idx);
	thisTitle.classList.add('a-actived');
}

function Utf8ArrayToStr(array) {
	var out, i, len, c;
	var char2, char3;

	out = '';
	len = array.length;
	i = 0;
	while(i < len) {
		c = array[i++];
		switch(c >> 4) {
			case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:
				// 0xxxxxxx
				out += String.fromCharCode(c);
				break;
			case 12: case 13:
				// 110x xxxx 10xx xxxx
				char2 = array[i++];
				out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
				break;
			case 14:
				// 1110 xxxx 10xx xxxx 10xx xxxx
				char2 = array[i++];
				char3 = array[i++];
				out += String.fromCharCode(((c & 0x0F) << 12) |
				((char2 & 0x3F) << 6) |
				((char3 & 0x3F) << 0));
				break;
		}
	}
	return out;
}

function streamShowContent(content, titleIdx, msgId) {
	if (!content) return;
	if (titleIdx !== currTitleIndex) return;
	const chatItem = id(`chatItem${msgId}`);
	if (!chatItem) {
		appendMsgToList(msgId, content, AVATAR_AI);
		return;
	}
	const msgDiv = idSlct('.content', chatItem);
	myHighlightElement(msgDiv, content);
	chatList.scrollTo(0, chatList.scrollHeight);
}

async function getText(prompt, callback, retry=false) {
	if (settings.apikey.length < 1) {
		alert("APIKEY 为空！请在【设置】中输入并保存");
		id('settingsDiv').style.display = 'block';
		return;
	}
	if (!retry && !prompt) {
		alert("输入消息为空，不能发送请求");
		return;
	}
	
	const tmpTitleIdx = currTitleIndex;
	let tmpMsgId = currMsgId;
	const tmpTitle = `chatTitle${tmpTitleIdx}`;
	let reqMsgList = [];
	if (chatMap && chatMap.hasOwnProperty(tmpTitle) && chatMap[tmpTitle].msgs.length > 0) {
		const msgs = chatMap[tmpTitle].msgs;
		for (let i = 0; i < msgs.length; i++) {
			if (msgs[i].id == -1) {
				reqMsgList.push({
					'role': 'system',
					'content': msgs[i].content
				});
				continue;
			}
			let role = 'assistant';
			if (msgs[i].avatar === AVATAR_USER) {
				role = 'user';
			}
			if (retry && i === msgs.length - 1 && role === 'assistant') {
				currMsgId -= 1;
				tmpMsgId -= 1;
				const msgDiv = idSlct('.content', id(`chatItem${currMsgId}`));
				msgDiv.innerHTML = '';
				break;
			}
			reqMsgList.push({
				'role': role,
				'content': msgs[i].content
			});
		}
	}
	// console.log(reqMsgList);

	if (!reqMsgList || reqMsgList.length == 0) return;

	let result = '';
	try {
		const response = await fetch(openaiEndpoint, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'Authorization': `Bearer sk-${settings.apikey}`
			},
			body: JSON.stringify({
				model: "gpt-3.5-turbo",
				messages: reqMsgList,
				stream: true
			})
		}).then(function(response) {
			// console.log(response);
			// console.log(`then ... [${response.status}:${response.statusText}]`);
			// if (!response.ok) {
			// 	throw Error(`[${response.status}:${response.statusText}]`);
			// }
			return response;
		}).catch(function(error) {
			// console.log(error);
			throw error;
		});
		const reader = response.body.getReader();
		while (true) {
			const { done, value } = await reader.read();
			// console.log(value);
			if (done) break;
			if (value && value.length > 1) {
				const data = Utf8ArrayToStr(value);
				// console.log(data);
				try {
					const errJson = JSON.parse(data);
					callback('```JSON\n' + data + '\n```', tmpTitleIdx, tmpMsgId);
					return;
				} catch (e) {}
				const json = data?.slice(6);
				const jsonArry = json?.split("data: ");
				for (let i = 0; i < jsonArry.length; i++) {
					if (jsonArry[i] !== "[DONE]\n\n") {
						const delta = JSON.parse(jsonArry[i])?.choices?.[0]?.delta;
						if (delta?.hasOwnProperty("content")) {
							// console.log(delta.content);
							result += delta.content;
							if (tmpTitleIdx === currTitleIndex) {
								callback(result, tmpTitleIdx, tmpMsgId);
							}
						}
					}
				}
			}
		}
	} catch (e) {
		// console.log(e);
		// callback(String(e), tmpTitleIdx, tmpMsgId);
		appendMsgToList(tmpMsgId + 1, String(e), AVATAR_AI);
		idSlct('.content', id(`chatItem${tmpMsgId + 1}`)).style.color = 'red';
	}
	if (result && result.length > 0) {
		callback(result, tmpTitleIdx, tmpMsgId);
		if (retry) {
			const lastMsg = chatMap[`chatTitle${tmpTitleIdx}`]['msgs'][chatMap['chatTitle1']['msgs'].length - 1];
			if (lastMsg.avatar === AVATAR_AI) {
				lastMsg.content = result;
			}
		} else {
			chatMap[`chatTitle${tmpTitleIdx}`]['msgs'].push({
				"id": tmpMsgId,
				"content": result,
				"avatar": AVATAR_AI
			});
		}
		if (tmpTitleIdx === currTitleIndex) {
			currMsgId += 1;
		}
	}
	regenerate.style.display = 'block';
}

function disableElement(e, flag=true) {
	let e_ = e;
	if (typeof e == 'string') {
		e_ = id(e);
	}
	if (flag) {
		e_.disabled = true;
		e_.style.backgroundColor = '#ccc';
		e_.style.cursor = 'not-allowed';
	} else {
		e_.disabled = false;
		e_.style.backgroundColor = '';
		e_.style.cursor = '';
	}
}

function myMarked(text) {
	if (!settings.hljs) {
		const p = document.createElement('p');
		p.innerText = text;
		return p.outerHTML;
	}
	return marked.parse(text);
}

function myHighlightElement(e, t) {
	if (!settings.hljs) {
		e.innerHTML = t;
		return;
	}
	// const tmpDiv = document.createElement('div');
	// tmpDiv.innerHTML = myMarked(t);
	// var blocks = tags("code", tmpDiv);
	e.innerHTML = myMarked(t);
	var blocks = tags("code", e);
	for (let block of blocks) {
		hljs.highlightElement(block);
		hljs.initLangBlock(block);
		hljs.lineNumbersBlock(block);
	}
	// e.innerHTML = tmpDiv.innerHTML;
}

// function showScroll(e) {
// 	e.scroll.style.display = 'block';
// 	setTimeout(() => {
// 		e.scroll.style.display = 'none';
// 	}, 400);
// }
// chatInput.addEventListener('scroll', function(){
// 	console.log(this);
// 	showScroll(this);
// });

function onLoad() {
	for (var key in roleMap) {
		const role = roleMap[key];
		let opt = document.createElement('option');
		opt.value = key;
		opt.disabled = role?.disabled;
		opt.selected = role?.selected;
		if (role?.selected && settings.role === '') {
			settingsRole.value = settings.role = key;
		}
		opt.text = role?.text;
		settingsRole.appendChild(opt);
	}
	if (isMobile) {
		;
	} else if (isWin) {
		chatInput.placeholder = chatInput.placeholder + '，按 Ctrl + Enter 发送';
	} else if (isMac) {
		chatInput.placeholder = chatInput.placeholder + '，按 Command + Enter 发送';
	}

	hljs.addPlugin(new CopyButtonPlugin());
	// hljs.addPlugin(
	// 	new CopyButtonPlugin({
	// 	hook: (text, el) => text + "\n[Copied from YtBot.]",
	// 	})
	// );
	hljs.highlightAll();
	hljs.initLangOnLoad();
	hljs.initLineNumbersOnLoad();

	var rendererMD = new marked.Renderer();
	marked.setOptions({
		renderer: rendererMD,
		gfm: true,
		tables: true,
		breaks: true,
		pedantic: false,
		sanitize: false,
		smartLists: true,
		smartypants: true
		// highlight: function (code) {
		// 	return hljs.highlightAuto(code).value;
		// }
	});
}

onLoad();
